NextJS 애플리케이션에서

데이터 로딩을 하는것에 있어서

몇가지 선택권이 있습니다

어떤 바닐라 리액트 애플리케이션에서 하는 것처럼

똑같이 할 수도 있습니다

예를들어 이렇게 useEffect 훅을 사용하여

그 안에 fetch 함수를 사용해

백엔드로 요청을 넣을 수 있습니다

그리고 그 백엔드에서

방금 설정한 데이터베이스로 가서

그곳에서 데이터를 가져올 수 있습니다

NextJS 애플리케이션에서는

사실 이미 백엔드를 가지고 있습니다

백엔드와 프론트엔드가 결합이 되었고

원활하게 혼합되어 있습니다

그렇기에 백엔드를 분리시킬 필요가 없습니다

그리고 배우셨듯이 NextJS에서는 기본적으로

모든 컴포넌트들이 서버에서만 실행되는 서버 컴포넌트 입니다

useEffect처럼 클라이언트 컴포넌트가 되어야 하는

기능을 사용하지 않는 한 그렇습니다

하지만 실제로 서버 컴포넌트가 기본이기 때문에

useEffect을 사용하지 않아도 되고

데이터를 가지러 fetch 요청을 보내지 않아도 됩니다

대신 이 컴포넌트가 기본값으로 서버에서만

실행되기 때문에 여기서 바로

데이터베이스로 갈 수 있습니다

그리고 이것은 다른 리액트 어플 사용할때와 달라

익숙하지 않으실 것 입니다

하지만 Next 앱을 사용할땐 괜찮습니다

왜냐하면 이것은 서버에서만 실행되는

서버 컴포넌트이기 때문입니다

그래서 여기서 데이터베이스에 도달하는것은 안전한 방법입니다

이제 몇가지것들을 분리시키기 위해

여기에 코드를 쓰지 않겠습니다

대신에 root 프로젝트 폴더 안에 새로운 폴더를 만들어

Lib이라고 하겠습니다, 이름은 원하시는대로 하시면 되고

정해진것은 없습니다

그 안에 새로운 파일, meal.js를 추가하겠습니다

그리고 그 안에서 데이터베이스에 도달하고

그 데이터베이스에서 데이터를 가져올 수 있는 코드를 쓰겠습니다

그러면 이 안에

Better-sqlite3 패키지 안에서 sql을 임포트 하겠습니다

데이터베이스 연결을 하기 위하여

SQL을 함수로 만들어

데이터베이스의 이름을 string (문자열)로

이 함수에 전달시킵니다

그리고 DB 객체를 가져와서

이 데이터베이스에 작업하도록 할 수있습니다

그러기위하여 여기에 export function을 추가하여

GetMeals라고 이름짓겠습니다

이름이 함축한대로

데이터베이스에서 모든 식사(meal)을 가져올것입니다

그리고 이 DB 객체를 사용하여

새로운 SQL문을 준비하여

실행될 수 있게 합니다

제법 단순한 문입니다

Meals표에서 모든 열을 select (선택) 하고싶습니다

그리고 이것을 실행시키면 되는데

여기선 run 방식을 사용하지 않고

All 방식을 사용합니다

Run은 데이터를 주입시킬때, 예를 들면

데이터를 바꿀때 사용하게 됩니다

All은 데이터를 불러올때, 그러니까

이 문장에 의해 가져오는 모든 행을

가져올 때 사용합니다

하가지 열만 찾고싶다면

Get을 사용하셔도 됩니다

하지만 여기선 여러개의 줄이기 때문에 all을 사용하고

여기서 결과값을 받으면 됩니다

이것은 promise나 비슷한것을 생성하지 않고

그냥 이렇게 반환 시키시면 됩니다

Promise 얘기가 나와서 말인데

여기선 사용하지 않지만

알고 이해할 가치가 있습니다

여기 better-sqlite3는 사용하지 않습니다

여기서는 사용하지 않지만

여기 이 컴포넌트에서는 쉽게 사용할 수 있습니다

왜냐하면 서버 컴포넌트 함수들이 실제로

Asyn 함수로 바뀔수 있기 때문입니다

여기에서 async 키워드를 사용할 수 있습니다

마찬가지로 리액트 컴포넌트에서는

할 수 없었던 일입니다

하지만 서버 컴포넌트에서는 할 수 있고

만약 promise를 사용하는 코드가 있었다면

여기에 await을 사용할 수 있습니다

이것을 구현하기 위해서는 Meals.JS로 돌아가서

getMeals 함수를 async로 바꾸어줍니다

그렇게하면 promise가 리턴됩니다

일반적으로 이 코드가 그렇지 않아도

지금은 promise에 감싸져 있습니다

이게 async가 하는 일입니다

그리고 여기 다른 promise를 await하겠습니다

그렇게 하면 임의의 지연이 발생되어

시간이 조금 더 걸리는 동작을 시뮬레이션 하게됩니다

이것은 우리가 나중에 Next 애플리케이션에서

State(상태) 로딩 같은것을 다룰때

도움이 될 것입니다

그리고 보통의 경우 속도를 느리게 하고싶지 않기 때문에

이런 코드를 잘 사용하지 않습니다만

이 데모 앱에서는

추가 지연을 넣겠습니다

이렇게 함으로서 여기에서 async await을

이것이 일반 함수이기 때문에

사용할 수 있음을 보여줍니다

그리고 여기 컴포넌트 함수에도 사용할 수 있습니다

이것은 리액트에선 하지 않지만

서버 컴포넌트에서는 할 수 있는 일입니다

그러니 여기서 getMeals를 await 해서

식사(meals) 정보를 가져옵니다

그러면 여기에 정보를 받을 수 있습니다

UseEffect를 사용하거나

불필요한 데이터 fetch 기능을 사용하지 않고서

이게 되었으니

이 meal 정보를 여기 밑쪽에

MealsGrid에 사용할 수 있습니다

간단하게 MealsGrid로 meals를 전달시키면 됩니다

그리고 모든 것을 저장하고

서버를 재실행 하면

이 식사 페이지를 로딩하여 모든 식사를 확인할 수 있습니다

그리고 간단한 참고로

제가 이 영상을 녹화할때

스타일링 에러가 하나 있었습니다

지금 화면에 보이는 것입니다

첨부파일에서는 스타일링 에러를 고쳤으니

여러분에겐 이렇게 보일것입니다

그거 말고는 다른게 없습니다

하나의 스타일링 문제였고

여러분 페이지에는 제목이 있는데

왜 여기는 안보이는지 궁금하실까봐

얘기해드리고 싶었습니다

상세페이지로 들어가는것은 작동은 되지만

아직 그 로직을 추가하지 않았기때문에

아무것도 보여지지 않을것입니다

하지만 여기 식사는 보입니다

이것은 데이터베이스에서 데이터가 불려오는것이고

저장되어있는 public 폴더에서

사진이 불려오는것입니다

그리고 결국 데이터 베이스에

저장된 패스가 그곳을 향할것입니다

그리고 이 이미지들은

Meal-itemJS 파일에서 설정한대로 보여집니다
