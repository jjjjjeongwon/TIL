이제 음식을 공유하는 것은 끝났습니다

하지만 우리 애플리케이션에는 한 가지 문제가 있습니다

개발 서버를 이용한 개발 환경에서는

모두 잘 동작합니다

그러나 배포 환경에서는 상황이 달라집니다

개발 환경에서 배포 환경으로 변경하기 위해서

개발 서버를 종료합니다

그리고 다른 터미널에서

프로젝트 폴더로 이동합니다

그리고 npm run build 명령어를 입력하여

NextJS 어플리케이션이

배포 환경에서 동작할 수 있게 준비합니다

이 명령어는 기본적으로 서버에 배포할 수 있는

프로젝트를 만들어 줍니다

npm start 명령어로 최적화된 코드의

배포 서버를 실행할 수 있습니다

첫 번째로 npm run build, 두 번째로 npm start 입니다

두 명령어를 입력하면 서버가 시작되는데

개발 환경 서버가 아닌

배포 환경 서버로서

동일한 주소로 서버가 열리지만

최적화된 코드로 서버가 열립니다

이제 다시 localhost:3000 으로 사이트를 방문할 수 있지만

여전히 음식들이 잘 보입니다

그러나 음식을 추가해보면

무언가 이상한 점이 보이게 될 것 입니다

다시 데이터를 입력하고

tasty Bruschetta (맛있는 브루스케타) 라고 이름 짓고

요약에는 Very delicious! (굉장히 맛있습니다)

안내는 이렇게 적겠습니다 (1. 빵을 자른다 2. ...)

그리고 항상 고르던 이미지를 선택한 후

버튼을 클릭하면 리다이렉트되는데

이전 강의에서 언급한 것처럼 더 빠릅니다

좋습니다 더 빠른 것은 더 좋은 사용자 경험이기 때문입니다

그러나 음식이 보이지 않습니다

이전에 제출한 세 음식은 보이는데

방금 새로 등록한 음식은 보이지 않습니다

very delicious (굉장히 맛있습니다) 라는 글자를 입력했는데

전혀 보이지 않습니다

한 가지 더 있습니다

이 사이트에서는 동작이 이상합니다

메인 페이지로 간 후에 새로 고침을 하고

음식 목록으로 가면

거의 바로 이동합니다

이 페이지에서 새로 고침을 하면

이 또한 거의 바로 새로 고침 됩니다

이전에는 페이지가 로딩되는 데 5초가 걸렸었습니다

meals.js에 딜레이를 걸어 두었기 때문입니다

바로 이 딜레이 입니다

이 딜레이가 배포 환경에서 동작하지 않고

새로 등록한 음식이 보이지 않는 이유는

이전 강의에서 말씀드렸듯이

NextJS가 꽤 공격적인 캐싱을 하고

배포 환경을 위해 앱을 준비할 때 그리고

동작할 때 거치는 추가 단계가 하나 있습니다

이 단계는 개발 환경 서버에서 테스트 할 때는

보지 못했던 것 입니다

배포 환경 에서의 앱을 준비하기 위해

npm run build 명령어를 실행하게 되면

NextJS는 실제로 앱에서 사전 생성될 수 있는 모든 페이지를

모두 사전 렌더링하고 생성하여

기본적으로는 동적 웹페이지가 아니게 됩니다

그래서 예를 들어 meals 페이지를 사전 생성합니다

그래서 meals 폴더의 이 page.js 파일이

출력된 음식과 함께

사전 생성됩니다 즉 빌드 프로세스에서

모든 데이터를 불러오고 렌더링 합니다

NextJS는 모든 페이지를

사전 렌더링 함으로써

배포된 직후부터 모든 페이지가

동작할 수 있게 합니다

그래서 웹 사이트의 가장 첫 방문자도

렌더링을 기다릴 필요 없이 즉시 완성된 페이지를

볼 수 있게 됩니다

물론 이는 훌륭한 사용자 경험이 될 수 있습니다

그런 다음 NextJS는 사전 렌더링된 페이지들을 캐싱하여

모든 방문자에게 제공할 수 있게 합니다

그러나 이 방식의 단점은 당연하게도

음식의 데이터를 다시 가져오지 않는 것 입니다

왜냐하면 이 코드가 다시 실행되지 않고

그냥 사전 생성된 페이지를 사용합니다

간단하게 증명할 수 있는 방법은 'fetching meals' (식사 fetching하는 중)이라고

콘솔에 로그를 출력하는데 meals 페이지에 사용되는

meals 컴포넌트에서 실행 합니다

그리고 npm run build 명령어로

프로젝트를 다시 빌드하면 보시는 것처럼

모든 페이지를 생성하고

생성이 끝나면 배포 서버를 시작하고

meals 페이지를 새로 고침 하면 터미널에 '식사 fetching하는 중'이라는 로그를 볼 수 없습니다

Image 컴포넌트를 사용할 때 도움을 주는

추가 패키지를 설치하라는 경고가 뜨는데

무시해도 상관없습니다

중요한 것은

이 로그가 출력되지 않는다는 것 입니다

이 페이지들은 사전 생성되었고

캐싱되었기 때문에 다시 실행되지 않는 것 입니다

지금 제 경우와 같이 페이지에서 보이는 데이터가

변화하게 된다면 이는 문제가 됩니다

아까 등록한 최신 음식이 지금은 보여지는데

이는 페이지를 다시 생성했기 때문이고

또 다른 새 음식을 추가한다면

또 다시 보이지 않을 것 입니다

그리고 이러한 동작은

우리가 원하는 것이 절대 아닙니다
