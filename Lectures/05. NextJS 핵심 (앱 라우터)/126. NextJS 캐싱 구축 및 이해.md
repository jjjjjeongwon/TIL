# 126. NextJS 캐싱 구축 및 이해

# 🚫 한 가지 문제가 있음

- 개발 서버를 이용한 개발 환경에서는 모두 잘 동작하는데 **배포 환경에서는 상황이 달라짐**
- 배포 환경으로 변경하기 위해서는 `npm run build` + `npm start`
  - 이 명령어는 기본적으로 서버에 배포할 수 있는 프로젝트를 만들어 준다

## 이렇게 접속한 localhost:3000에서는?

### 📌 새로 등록한 음식이 보이지 않음

- 데이터를 입력하고 이미지를 선택한 후 버튼을 클릭하면 리다이렉트되는데 더 빠르지만 음식이 보이지 않음(새로 등록한 음식)

### 📌 사이트에서 동작이 이상함.

- 메인 페이지로 간 후에 새로 고침을 하고 음식 목록으로 가면 거의 바로 이동
- 이 페이지에서 새로 고침을 하면 이 또한 거의 바로 새로 고침 됨
  - 이전에는 페이지가 로딩되는 데 5초가 걸렸었음
  - `meals.js`에 딜레이를 걸어 두었기 때문
- 이 딜레이가 배포 환경에서 동작하지 않고 새로 등록한 음식이 보이지 않는 이유는
  **NextJS가 꽤 공격적인 캐싱을 하고 배포 환경을 위해 앱을 준비할 때 동작할 때 거치는 추가 단계**가 있기 때문임

## 💡 배포 환경에서 앱을 준비할 때 거치는 추가 단계?

배포 환경 에서의 앱을 준비하기 위해 `npm run build` 명령어를 실행하게 되면 NextJS는 실제로 앱에서 사전 생성될 수 있는 모든 페이지를 모두 사전 렌더링하고 생성하여 기본적으로는 동적 웹페이지가 아니게 됨

- 예를 들어 meals 페이지를 사전 생성
- 그래서 `meals 폴더`의 이 `page.js` 파일이 출력된 음식과 함께 사전 생성됨
- 즉 빌드 프로세스에서 모든 데이터를 불러오고 렌더링
- NextJS는 모든 페이지를 사전 렌더링 함으로써 배포된 직후부터 모든 페이지가 동작할 수 있게 함
  - 그래서 웹 사이트의 가장 첫 방문자도 렌더링을 기다릴 필요 없이 즉시 완성된 페이지를 볼 수 있게 됨
- 이는 훌륭한 사용자 경험이 될 수 있음
  → 사전 렌더링된 페이지들을 캐싱하여 모든 방문자에게 제공할 수 있게 하기 때문에

## 사전 렌더링된 페이지들을 캐싱하여 제공하는 방식의 단점?

- 당연하게도 음식의 데이터를 다시 가져오지 않는 것
- 왜냐하면 이 **코드가 다시 실행되지 않고 그냥 사전 생성된 페이지를 사용하기 때문**
- 간단하게 증명할 수 있는 방법은 'fetching meals'이라고 콘솔에 로그를 출력하는데 meals 페이지에 사용되는 meals 컴포넌트에서 실행함
- 그리고 `npm run build` 명령어로 프로젝트를 다시 빌드하면 보시는 것처럼 모든 페이지를 생성하고 생성이 끝나면 배포 서버를 시작하고 meals 페이지를 새로 고침 하면 터미널에 'fetching meals'이라는 로그를 볼 수 없음
- 이 페이지들은 **사전 생성되었고 캐싱**되었기 때문에 **다시 실행되지 않는 것**
- 이 경우와 같이 페이지에서 **보이는 데이터가 변화하게 된다면 이는 문제가 됨**
