## 💡 클라이언트 사이드 데이터 페칭 코드에는 장점도 있음

전체 컴포넌트 상태를 완전히 제어할 수 있으며 데이터 페칭 방식을 통제하니까.

또 이런 패턴은 일반적이라서 자체 **사용자 정의 훅을 생성하여 이 논리를 거기에 아웃소싱하거나 타인이 만든 서드 파티 훅을 사용**할 수 있음

## SWR (stale-while-revalidate) 훅을 살펴보자!

> Google에 useswr을 검색하면 swr.vercel.app이 나옴. Next.js 팀에서 개발한 React 훅인데 Next.js가 아닌 프로젝트에서도 사용할 수 있음.

이 훅은 기본적으로 HTTP 요청을 보낼 때 우리가 앞서 다루었던 fetch API를 사용

여기에는 몇 가지 내장 기능이 있음

- **캐싱 및 자동 유효성 재검사와 에러 시 요청 재시도 등**이 있고 코드 전체를 직접 작성하지 않아도 됨
- 이 훅을 사용하면 훨씬 간단하게 할 수 있음. 왜냐하면 이 훅의 내장 기능이 바로 데이터 캐싱과 최신 데이터를 제공하기 위한 데이터 유효성 재검사 등이니까!
- npm install swr을 실행하여 swr 훅 패키지를 설치 (last-sales 파일에서 사용하기 위해 임포트)
  `import useSWR from 'swr'`

useEffect 내부가 아니라 컴포넌트에 직접 사용. React 훅은 중첩 함수가 아니라 컴포넌트에 직접 사용해야 함

useSWR()로 간단히 실행해 주면 됨

이때 하나 이상의 인수로서 보낼 요청의 식별자가 필요한데 일반적으로는 그 요청의 URL이 필요

- 식별자라고 부르는 이유는 이 훅이 같은 URL에 여러 요청을 한 번에 묶어 보내기 때문.
- 작은 요청을 여러 번 보내지 않고 특정 기간 동안 한 번의 요청으로 전송하는 것
- 여기서는 상관이 없지만 보통은 사용하는 게 편함 따라서 여기 있는 URL을 식별자로 가져옴 그러면 이 식별자를 편리하게 URL로도 사용할 수 있음

두 번째 인수로 fetcher() 함수를 넣어줘야 함

- 요청이 어떤 방식으로 전송될지 정하는 함수.

이렇게 useSWR()을 호출하고 컴포넌트가 로딩되면 URL로 요청이 전송되고 그러면 훅으로 반환된 데이터로 작업을 할 수 있게 됨

그 데이터가 바로 구조 분해 가능한 객체인데 **페칭된 데이터 및 잠재적인 에러 정보를 포함**하고 있음

따라서 여기에 동일한 객체 구조 분해를 사용하고 우리가 얻게 될 데이터와 생길 수 있는 에러를 풀(pull)

아래의 사용자 지정 코드에는 에러 핸들링이 없지만 useSWR 훅으로 얻게 되는 이 추가 데이터를 사용하면 쉽게 구현할 수 있음

이제 커스텀 훅을 주석 처리(삭제해도 되지만 참고용으로 남겨둠)

사용자 정의 상태 역시 주석 처리할 수 있음

지금부터는 데이터 및 에러를 가지고 작업할 수 있음

아직 데이터가 없다면 로딩 중

if(!data)로 데이터가 없는지 확인하고 Loading...을 반환

반면 if(error)에서 에러가 있을 경우 표시할 에러 메시지는 'Failed to load.' 이 부분은 if(!data)의 앞으로 옮김

로딩된다고 표시하는 것보다는 에러를 표시하는 게 더 중요하니깐! 에러가 생기면 표시해야 함

에러는 없고 데이터가 있다면 즉 두 가지 if() 확인을 거치고 데이터를 출력

## 하지만 문제가 하나 발생하는데 Firebase에서 반환되는 데이터는 옳은 형식이 아니라 변환해야 함‼️

## 📌 이 문제를 해결하는 데 두 가지 접근 방법이 있음

### ✔️ 자체 fetcher() 함수를 정의

- SWR 문서에서 방법을 배울 수 있음
- 데이터가 페칭되고 반환되는 정확한 방식을 조정할 수 있음.

### ✔️ useEffect를 사용하는데 이번에는 요청을 보내지 않고 단순히 데이터 변환에만 사용하는 방법

- 이때 의존성이 바로 우리가 얻을 data. 새로운 데이터를 얻을 때마다 이 훅을 반복할 것이기 때문
- useEffect에서 if()로 데이터가 있는지 확인하고 만약 데이터가 없으면 아무것도 할 일이 없지만 데이터가 있을 경우 이러한 변환 단계를 실행
- 아래에서 복사한 코드를 넣어서 주석 처리를 풀어주고 sales 상태도 코드로 되돌리면 useEffect의 데이터 변환 다음에 sales 상태를 설정할 수 있음
- useEffect의 if() 내부에 setSales()를 transforedSales로 설정하는데 이는 useSWR에서 얻는 데이터 키를 기반으로 함

이렇게 자체적인 변환 논리를 만들었음

데이터가 페칭되면 바로 시작될 것임

그런데 이 경우 아래에서 데이터가 있는지 확인해도 변환되지 않은 상태일 수 있음

if(!sales)로 확인해서 sales, 즉 변환된 데이터가 없다면 여기도 Loading...이라는 단락을 반환

||를 써서 병합할 수도 있어요 만약 data가 없거나 혹은 sales가 없을 경우 Loading...을 반환

둘 다 가지고 있다면 안전하게 sales를 출력할 수 있음

이렇게 useSWR을 사용하면서 자체 변환 논리를 적용할 수 있고 여기까지 저장한 다음 개발 서버를 재시작하면 정상 작동되는 페이지가 다시 나타남

지난 판매 화면을 새로 고침 하면 Loading... 후에 데이터가 보임

페이지 소스를 확인해도 데이터는 볼 수 없지만 이제 Loading...이 표시됨

Loading...이 나오는 건 이 시작 상태가 바로 컴포넌트 초기 버전이 렌더링되기 때문

처음에는 에러가 정의되지 않으므로 이 텍스트는 반환되지 않고 data와 sales가 정의되지 않으니 이 텍스트가 반환되는 것

그래서 이 부분이 사전 렌더링 된 페이지의 일부처럼 보이게 됨

다시 정리하지만, 데이터 페칭은 클라이언트 사이드에서만 이루어짐

useSWR 훅을 의무적으로 사용해야 하는 건 아님

자체 논리를 작성하고 이 훅을 쓰지 않아도 됨. 다만 이 훅을 사용하면 편리하게 코드를 줄일 수 있음

특히 아래에 에러 핸들링을 추가하고 싶을 때 더욱 그렇고 다른 기능도 많음(포커스를 잃거나 다시 얻을 때 자동으로 데이터 페칭을 해주는 등 많은 기능이 있음)
